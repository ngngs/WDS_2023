# 클린코드 35일차

## 18장 동시성2 (3)

### 데드락
데드락을 근본적으로 해결하려면 원인을 이해해야 한다. 

데드락은 다음 4가지 조건을 만족하면 발생한다.
1. 상호 배제 (Mutual exclusion)
2. 잠금 & 대기 (Lock & Wait)
3. 선점 불가 (No Preemption)
4. 순환 대기 (Circular Wait)

#### (1) 상호 배제
여러 스레드가 한 자원을 공유하나 그 자원은
- 여러 스레드가 동시에 사용하지 못하며
- 개수가 제한적인 경우
- ex) 데이터베이스 연결, 쓰기용 파일 열기, 세마포어 등

#### (2) 잠금 & 대기
일단 스레드가 자원을 점유하면 필요한 나머지 자원까지 모두 점유해 작업을 마칠 때까지 이미 점유한 자원을 내놓지 않는 것.

#### (3) 선점 불가
한 스레드가 다른 스레드로부터 자원을 빼앗지 못하여 자원을 점유한 스레드가 스스로 내놓지 않는 이상 다른 스레드는 그 자원을 점유하지 못하는 것.
#### (4) 순환 대기
T1, T2라는 스레드 2개가 있고, R1, R2라는 자원 2개가 있다고 가정하자. T1이 R1을 T2가 R2를 점유한 상태에서 T1이 R2를 T2도 R2를 필요로 할 때 순환 대기가 걸리게 된다.

### 데드락 해결법 (각 조건 깨는 방법)
#### (4) 순환 대기
**데드락을 방지하는 가장 흔한 전략**이다. **대다수 시스템에서는 모든 스레드가 동의하는 간단한 규약이면 충분**하다.

즉 T1, T2가 자원을 똑같은 순서로 할당하게 만들면 순환 대기는 불가능해진다. 쉽게 말해 모든 스레드가 일정한 순서에 자원을 할당받게 설정하면 데드락은 불가능하다.

다만, 이것 또한 아래의 문제를 일으킬 소지가 있다.
- 자원을 할당하는 순서와 자원을 사용하는 순서가 다를 때(ex. 맨 처음 할당한 자원을 나중에 쓸 때). 이렇게 되면 자원을 필요 이상으로 오랫동안 점유할 가능성이 있다.
- 애초에 순서에 따라 자원을 할당하기 어려울 때. (ex. 첫 자원을 사용한 후에야 둘째 자원 ID를 얻는 경우)

### 다중 스레드 코드 테스트 
pp.436~438에 있는 테스트 코드를 꼭 따라해보도록 하자.
